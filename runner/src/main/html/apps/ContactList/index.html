<!DOCTYPE html>
<html>
<style>
    .presenceBubble {
        width: 10px;
        height: 10px;
        float: left;
    }
</style>

<script>
    var connection = null;

    function establishConnection() {
        connection = new WebSocket('ws://' + window.location.host + '/events');

        connection.onopen = function () {
            var json = {"action": "getContactList"};
            connection.send(JSON.stringify(json));
        };

        connection.onclose = function () {
        };

        connection.onmessage = function (e) {
            var message = JSON.parse(e.data);
            if (message["action"] === "addContacts") {
                var contacts = message["data"];
                contacts.forEach(function (item) {
                    if (getContact(item["contact"]) == null) {
                        var container = createContactNode(item["contact"]);
                        document.getElementById("contacts").appendChild(container);
                        changePresenceBubbleForContact(item["contact"], item["presence"]);
                    }
                });
            }
            else if (message["action"] === "presenceUpdate") {
                var update = message["data"];
                changePresenceBubbleForContact(update["contact"], update["presence"]);
            }
        }
    }

    function changePresenceBubbleForContact(contact, presence) {
        var contactDiv = getContact(contact);

        if (contactDiv != null) {
            var mappings = {"available": "limegreen", "away": "yellow", "donotdisturb": "red", "unknown": "grey"};
            contactDiv.querySelector("div.presenceBubble").style.backgroundColor = mappings[presence];
        }
    }

    function getContact(contact) {
        for (var i = 0; i < document.getElementById("contacts").childNodes.length; i++) {
            var child = document.getElementById("contacts").childNodes[i];

            if (child.nodeType == 1) {
                if (child.getAttribute("jid") === contact) {
                    return child;
                }
            }
        }
        return null;
    }

    function createContactNode(item) {
        var container = document.createElement("div");
        container.setAttribute("jid", item);
        container.setAttribute("draggable", "true");
        container.setAttribute("ondragstart", "drag(event)");
        container.appendChild(createHtmlElementFromText("<div class='presenceBubble'></div>"));
        container.appendChild(createHtmlElementFromText("<span>&NonBreakingSpace;" + item + "</span>"));
        container.appendChild(createHtmlElementFromText("<br />"));
        container.appendChild(createHtmlElementFromText("<br />"));
        return container;
    }

    function createHtmlElementFromText(code) {
        var div = document.createElement('div');
        div.innerHTML = code;
        return div.firstChild;
    }

    function setPresence(presence) {
        var json = {"action": "setPresence", "data": presence};
        connection.send(JSON.stringify(json));
    }

    function addContact() {
        if (document.getElementById("addContact").value !== "") {
            var json = {"action": "addContact", "data": document.getElementById("addContact").value};
            connection.send(JSON.stringify(json));
            document.getElementById("addContact").value = "";
        }
    }

    function drag(ev) {
        ev.dataTransfer.setData("text", ev.target.attributes["jid"].value);
    }
</script>
<body onLoad="establishConnection()">
<span><select onChange="setPresence(this.options[this.selectedIndex].value)">
    <option value="available">{{available}}</option>
    <option value="away">{{away}}</option>
    <option value="donotdisturb">{{doNotDisturb}}</option>
</select>
<input id="addContact"/><button type="button" onclick="addContact()">{{addContact}}</button></span><br/><br/>

<div id="contacts">
</div>

</body>
</html>
